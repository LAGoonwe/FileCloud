
<!DOCTYPE html>
<html>
<head>
    <title>宙斯云盘-文件管理</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/uikit.min.css" />
    <script src="../js/uikit.min.js"></script>
    <script src="../js/uikit-icons.min.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>

    <!--分页相关-->
    <link type="text/css" href="../css/style.css" rel="stylesheet" />
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/MyPage.js"></script>
    <style type="text/css">
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .header{
            width: 100%;
            height: 15%;
            background-color: #f8f8f8;
            border-bottom: 1px solid #96c2f1;
        }
        #warp{
            height: 85%;
            width: 100%;
            display: flex;
        }
        .lefter{
            width: 10%;
            background-color: #f8f8f8;
            border-right: 1px solid #96c2f1;
        }
        .righter{
            width: 100%;
            float: left;
            background-color: #f8f8f8;
        }
        .logo{
            height: 100%;
        }

         .searchResult{width: 500px;position: absolute; background-color: #fff;
            border: 1px solid #bbb; overflow: hidden; padding: 3px 5px;box-sizing: border-box;max-height:280px;overflow-y:auto;margin-top: 0!important;}
         .hide{display: none}
        .searchResult li{padding:3px 0;}
        .searchResult li:hover{cursor:pointer;}
    </style>
</head>
<body>

<!--头部logo以及标题div-->
<nav class="uk-navbar-container uk-margin header" uk-navbar style="margin-bottom: 0px;background-color: #f8f8f8;">
    <div class="uk-navbar-left">
        <img class="logo" src="http://img.mp.itc.cn/upload/20170724/cf678e09eb384401aa616ba134126357_th.jpg">
        <ul class="uk-navbar-nav">
            <li>
                <a href="#">
                    <span class="uk-icon uk-margin-small-right" uk-icon="icon: star"></span>
                    宙斯云盘-文件管理
                </a>
            </li>
        </ul>
        <div class="uk-navbar-item">
            <form action="javascript:void(0)">
                <input id="searchInput" class="uk-input uk-form-width-large" type="text" placeholder="宙斯文件搜索--可根据用户名和文件名搜索">
                <ul class="searchResult hide">ww</ul>
                <button class="uk-button uk-button-primary" href="#modal-full" uk-toggle onclick="SearchFilesByUserNmae()" >宙斯sou一下~</button>
            </form>
        </div>

        <!-- 搜索js逻辑 -->
        <script>
            var arry = new Array()
            function searchBtn(allusers,allfiles) {
                for (i=0;i<allusers.length;i++){
                    arry.push( allusers[i].Username)
                }
                for (j=0;j<allfiles.length;j++){
                    arry.push( allfiles[j].FileName)
                }
                var searchInput = $.trim($("#searchInput").val());
                // $(".searchResult").html(" ");
                if (searchInput == "") {}
                else {
                    if ($.inArray(searchInput, arry)>0) {   //如果input中的内容在数组中，
                        $(".searchResult").addClass("hide");
                    }
                    else {
                        $(".searchResult").addClass("hide");
                        alert("请输入正确的名称");
                    }
                }
            }
            $(function () {
                //input框输入内容时
                $("#searchInput").keyup(function () {
                    $(".searchResult").html("");
                    var searchInput = $.trim($(this).val().toString());
                    if (searchInput != "") {
                        $.each(arry, function (index, val) {
                            //如果输入的内容包括在数据中，就将其加入ul li中
                            if (val.indexOf(searchInput) != -1) {
                                $(".searchResult").append("<li>" + val + "</li>");
                            }
                            //如果ul中有子元素，则ul显示出来
                            if ($(".searchResult").html()!="") {
                                $(".searchResult").removeClass("hide");
                            }
                        })
                    }
                    //点击ul li中的数据，将其写入input中并清空ul中数据，隐藏ul。
                    $(".searchResult li").click(function () {
                        $("#searchInput").val($(this).html());
                        $(this).parent().html();
                        $(".searchResult").addClass("hide");
                    })
                    return false;
                })

            })
        </script>

        <button class="uk-button uk-button-primary" uk-toggle="target: #offcanvas-push" style="float: right;margin-right: 30px;">更多操作</button>

        <div class="uk-card-header">
            <div class="uk-grid-small uk-flex-middle" uk-grid>
                <div class="uk-width-auto">
                    <img class="uk-border-circle" width="40" height="40" src="http://b-ssl.duitang.com/uploads/item/201704/10/20170410095843_SEvMy.thumb.700_0.jpeg">
                </div>
                <div class="uk-width-expand">
                    <h3 id="adminname1" class="uk-card-title uk-margin-remove-bottom">文琪-ADMIIN</h3>
                    <p class="uk-text-meta uk-margin-remove-top"><span class="uk-label uk-label-danger">管理员</span></p>
                </div>
            </div>
        </div>

    </div>
</nav>
<!--搜索结果全屏模态框 -->
<div id="modal-full" class="uk-modal-full" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-full uk-close-large" type="button" uk-close></button>
        <div class="uk-grid-collapse uk-child-width-1-2@s uk-flex-middle" uk-grid>
            <div class="uk-background-cover" uk-height-viewport style="width: 100%">
               <br>
               <h2 style="text-align: center;">搜索结果</h2>
                <hr class="uk-divider-icon">
                <!-- 搜索结果展示tb-->
                <table id="filetbBySearch" class="uk-table uk-table-hover uk-table-divider">
                    <thead>
                    <tr>
                        <th>文件Hash值</th>
                        <th>文件名</th>
                        <th>文件大小</th>
                        <th>创建时间</th>
                        <th>最近修改时间</th>
                        <th>归属用户</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<!--更多操作抽屉 -->
<div id="offcanvas-push" uk-offcanvas="mode: push; overlay: true">
    <div class="uk-offcanvas-bar">

        <button class="uk-offcanvas-close" type="button" uk-close></button>

        <h3>更多操作</h3>

        <div class="uk-width-expand">
            <h3 id="adminname2" class="uk-card-title uk-margin-remove-bottom">文琪-ADMIIN</h3>
            <p class="uk-text-meta uk-margin-remove-top"><span class="uk-label uk-label-danger">管理员</span></p>
        </div>
        <br> <br>
        <button class="uk-button uk-button-primary" onclick="toFileMan()">文件管理</button>
        <br> <br>
        <button class="uk-button uk-button-primary" onclick="toFileMetaMan()">文件元数据管理</button>
        <br> <br>
        <button class="uk-button uk-button-primary" onclick="toIndex()">退出登录</button>
    </div>
</div>

<!--添加管理员模态框-->
<div id="modal-add-admin" uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <div>
            <div class="uk-background-muted uk-padding uk-panel">
                <div class="form">
                    <h1 class="uk-heading-line uk-text-center"><span style="font-size: 20px;">宙斯云盘-添加管理员</span></h1>
                    <!--用户名密码框开始-->
                    <div class="uk-margin">
                        <div class="uk-inline">
                            <span class="uk-form-icon" uk-icon="icon: user"></span>
                            <input class="uk-input" id="add-username" type="text" placeholder="管理员名长度不得为空！">
                        </div>
                    </div>
                    <div class="uk-margin">
                        <div class="uk-inline">
                            <span class="uk-form-icon" uk-icon="icon: lock"></span>
                            <input class="uk-input" id="add-password" type="password" placeholder="密码长度不得小于5！">
                        </div>
                    </div>
                    <div class="uk-margin">
                        <div class="uk-inline">
                            <span class="uk-form-icon" uk-icon="icon: lock"></span>
                            <input class="uk-input" id="add-passwordc" type="password" placeholder="请确认密码" onkeyup="validate()">
                        </div><br>
                        <span id="msg"></span>
                    </div>
                    <!--用户名密码框结束-->
                    <button style="width: 235px;" id="signup" class="uk-button uk-button-primary uk-width-1-1 uk-margin-small-bottom" onclick="onSignup()">确认添加</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="warp">
    <!--右部文件信息及操作div-->
    <div class="righter">
        <table id="filetbl" class="uk-table uk-table-hover uk-table-divider">
            <thead>
            <tr>
                <th>文件Hash值</th>
                <th>文件名</th>
                <th>文件大小</th>
                <th>创建时间</th>
                <th>最近修改时间</th>
                <th>归属用户</th>
                <th>操作</th>
            </tr>
            </thead>
        </table>

        <!-- 分页插件显示区域 -->
        <div style="position:absolute;bottom:0;right:0;margin-bottom: 20px" class="page" id="Page"></div>

        <!--删除确认模态框-->
        <div id="modal-delete" uk-modal>
            <div class="uk-modal-dialog uk-modal-body">
                <P>确认删除吗？</P>
                <p class="uk-text-right">
                    <button class="uk-button uk-button-default uk-modal-close" type="button">取消</button>
                    <button id="deleteActionButton" class="uk-button uk-button-primary" type="button">确定</button>
                </p>
            </div>
        </div>
    </div>
</div>
</body>

<script lang="javascript">

    //管理员添加逻辑检验
    <!-- 密码与确认密码一致性校验 -->
    function validate() {

        var pwd = $("#add-password").val();
        var pwd1 = $("#add-passwordc").val();
        <!-- 对比两次输入的密码 -->
        if(pwd == pwd1)
        {
            $("#msg").html("两次密码相同");
            $("#msg").css("color","green");
            $("#signup").removeAttr("disabled");
        }
        else {
            $("#msg").html("两次密码不相同");
            $("#msg").css("color","red")
            $("#signup").attr("disabled","disabled");
        }
    }


    function onSignup() {
        var username = document.getElementById('add-username');
        var password = document.getElementById('add-password');
        var passwordc = document.getElementById('add-passwordc');
        $.ajax({
            url: "/user/addAdmin",
            type: "POST",
            data: {
                "username": username.value,
                "password": password.value,
                "status":   7,
            },
            error: function (jqXHR, textStatus, errorThrown) {
                if (textStatus == "error") {
                    alert(textStatus + " : " + errorThrown);
                } else {
                    alert(textStatus);
                }
            },
            success: function (data, textStatus, jqXHR) {
                if (data == 'SUCCESS') {
                    // 成功后跳到登录页
                    UIkit.notification({message: '添加成功<br>返回至用户管理界面中...', status: 'success'})
                    setTimeout(() => {
                        window.location.href = '/static/view/admin.html';
                    }, 2000);

                }else if (data == "None passwordc"){
                    UIkit.notification({message: '请确认密码！', status: 'danger'})
                }else if (data == "invalid parameter"){
                    UIkit.notification({message: '用户名或密码长度有误！', status: 'danger'})
                }else if (data == "Signined"){
                    UIkit.notification({message: '该用户名已被注册！<br>请更换其他用户名！<br>用户名注册后不可修改！', status: 'danger'})
                }
                else {
                    console.log(data)
                    UIkit.notification({message: '注册失败', status: 'danger'})
                }
            }
        });
    }


    function toIndex() {
        // window.location.href = '/file/upload?' + queryParams();
        sessionStorage.clear();
        localStorage.clear();
        window.location.href = "/static/view/signin.html";
    }

    //跳转去文件本体管理页面
    function toFileMan() {
        alert("即将唤起文件内容管理页面...")
        window.open ("http://localhost:9090/static/view/FileAdmin.html");
    }

    //跳转去文件元数据管理页面
    function toFileMetaMan() {
        UIkit.notification({message: '即将跳转至文件元数据管理页面......！', status: 'success'})
        setTimeout(function(){
            window.location.href = "http://localhost:9090/static/view/FileMetaAdmin.html";
        }, 1500);
    }

    window.onload = function () {
        var username = document.getElementById('username');
        $.ajax({
            url: "/user/info?" + queryParams(),
            type: "POST",
            error: function (jqXHR, textStatus, errorThrown) {
                if (textStatus == "error") {
                    if (errorThrown == "Forbidden")
                        UIkit.notification({message: '请先登录本系统！', status: 'danger'})
                    setTimeout(function(){
                        window.location.href = "/static/view/signin.html";
                    }, 1000);
                } else {
                    UIkit.notification({message: textStatus, status: 'danger'})
                }
            },            success: function (body, textStatus, jqXHR) {
                var resp = JSON.parse(body);
                console.log(resp)
                document.getElementById("adminname1").innerHTML = resp.data.Username;
                document.getElementById("adminname2").innerHTML = resp.data.Username;
                FileTotal = resp.all_file_meta_total
                updateFileList(FileTotal)

                searchBtn(resp.all_users,resp.all_files)



            }
        });
    }

    /**
     *前端页面的时间格式化函数
     */
    function checkTime(i){
        if (i<10){
            i="0" + i
        }
        return i;
    }

    function formatDate(date) {
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var weekday = date.getDate();
        var hours = date.getHours();
        var minutes = date.getMinutes();
        var seconds = date.getSeconds();

        return (year + "-" + checkTime(month) + "-" + checkTime(weekday)+" "+checkTime(hours)+":"+
            checkTime(minutes)+":"+checkTime(seconds));
    }

    /**
     * 获取所有的文件名，辅助搜索
     */
    function GetAllFileNames() {

    }

        //设置全局变量，需要更改发送的账户状态值
    var sendStatus

    function updateFileList(FileTotal) {
        var pageIndex
        // 激活分页插件
        P.initMathod({
            params: {elemId: '#Page',total:'10',pageNum:3,pageSize:7},
            requestFunction: function () {
                //计算所需页码
                num = Math.ceil(FileTotal/7)
                P.config.pageNum = num
                P.config.total = FileTotal

                console.log(P.config)
                pageIndex = P.config.pageIndex

                $.ajax({
                    url: "/filebackend/all?" + queryParams(),
                    type: "POST",
                    data: {
                        PageIndex: pageIndex, // 当前点击的页码
                        PageSize: 7 //每页显示的条数
                    },
                    error: function (err) {
                        alert(JSON.stringify(err));
                    },
                    success: function (response) {
                        var dlHost = 'http://localhost:9090';
                        var dlEntry = localStorage.getItem('downloadEntry');
                        if (dlEntry != null) {
                            if (dlEntry.indexOf('http:')<0) {
                                dlHost = 'http://' + dlEntry;
                            } else {
                                dlHost = dlEntry;
                            }
                        }

                        var renameUserHtml = '<button id="{0}_status" class="uk-button uk-button-danger uk-button-small" ' +
                            'style="height:30px;margin:5px 3px;"' +
                            'onClick = "renameUser(\'{0}\',\'{1}\',\''+dlHost+'/status/' +
                            'update?CurlUsername={0}&{2}\')">权限设置</button>';

                        var upUserHtml = '<button id="{0}_up" class="uk-button uk-button-primary uk-button-small" ' +
                            'style="height:30px;margin:5px 3px;"' +
                            'onClick = "upUser(\'{0}\',1,\''+dlHost+'/status/' +
                            'update?CurlUsername={0}&{2}\')">本地下载</button>';

                        var deleteUserHtml = '<button id="{0}_delete" class="uk-button uk-button-danger uk-button-small" href="#modal-delete" uk-toggle' +
                            ' style="height:30px;margin:5px 3px;"' +
                            'onClick = "deleteUser(\'{0}\',\'' + dlHost + '/user/delete?username={0}&{1}\')">文件冻结</button>';


                        // 序列化返回内容，转化为json数据
                        response = JSON.parse(response)

                        // 解析json数据，如果code为-1，则展示错误信息，否则正常展示查询数据
                        if (response.code == -1){
                            UIkit.notification({message: response.msg, status: 'danger'})
                        }else {
                            console.log(response.data)
                            for (var i = 0; i < response.data.length; i++) {
                                var x = document.getElementById('filetbl').insertRow();
                                var cell = x.insertCell();
                                cell.innerHTML = response.data[i].FileSha1.substr(0, 20) + "...";


                                cell = x.insertCell();
                                // 截取盘符
                                Disk = response.data[i].FileAbsLocation.substring(0,response.data[i].FileAbsLocation.indexOf(":"))
                                // 截取路径
                                Path = response.data[i].FileAbsLocation.substring(response.data[i].FileAbsLocation.indexOf(":")+1,response.data[i].FileAbsLocation.length)
                                cell.innerHTML = "<a uk-tooltip="+response.data[i].FileName+" id='"+response.data[i].FileSha1+"'" +
                                    " target='_blank' href= '"+dlHost+"/"+Disk+Path+"'>"
                                    + response.data[i].FileName.substring(0,50)+"</a>";

                                cell = x.insertCell();
                                cell.innerHTML = response.data[i].FileSize;

                                cell = x.insertCell();
                                var UploadAt = new Date(response.data[i].UploadAt)
                                cell.innerHTML = formatDate(UploadAt);

                                cell = x.insertCell();
                                var LastUpdate = new Date(response.data[i].LastUpdate)
                                cell.innerHTML = formatDate(LastUpdate);

                                cell = x.insertCell();
                                cell.innerHTML = response.data[i].UserName;

                                cell = x.insertCell();
                                cell.innerHTML = renameUserHtml.format(response.data[i].Username, response.data[i].Status, queryParams())+
                                    upUserHtml.format(response.data[i].Username, response.data[i].Status, queryParams())+
                                    deleteUserHtml.format(response.data[i].Username, queryParams());


                                // if(data[i].Username == localStorage.getItem("username")){
                                //     realStatus = data[i].Username+"_status"
                                //     $("#"+realStatus).attr('disabled',true);
                                //     $("#"+data[i].Username+"_delete").attr('disabled',true);
                                // }
                            }
                        }
                    }
                });
                // 清除原有页面的表格数据---配合分页使用
                $("#filetbl tr:gt(0)").empty();
                $("#filetbl tr").not(':eq(0)').empty()
            }
        });
    }

    /**
     * 根据用户名搜索文件js
     */
    function SearchFilesByUserNmae() {

        if ( $('#searchInput').val() == ""){
            $("#filetbBySearch").hide()
        }

        $.ajax({
            url: "/filebackend/querybyname?"+queryParams(),
            type: "POST",
            data: {
                checkname:$('#searchInput').val(),
            },
            error: function (error) {
                alert(error);
            },
            success: function (response) {
                var dlHost = 'http://localhost:9090';
                var dlEntry = localStorage.getItem('downloadEntry');
                if (dlEntry != null) {
                    if (dlEntry.indexOf('http:')<0) {
                        dlHost = 'http://' + dlEntry;
                    } else {
                        dlHost = dlEntry;
                    }
                }

                var renameUserHtml = '<button id="{0}_status" class="uk-button uk-button-danger uk-button-small" ' +
                    'style="height:30px;margin:5px 3px;"' +
                    'onClick = "renameUser(\'{0}\',\'{1}\',\''+dlHost+'/status/' +
                    'update?CurlUsername={0}&{2}\')">权限设置</button>';

                var upUserHtml = '<button id="{0}_up" class="uk-button uk-button-primary uk-button-small" ' +
                    'style="height:30px;margin:5px 3px;"' +
                    'onClick = "upUser(\'{0}\',1,\''+dlHost+'/status/' +
                    'update?CurlUsername={0}&{2}\')">范围下载</button>';

                var deleteUserHtml = '<button id="{0}_delete" class="uk-button uk-button-danger uk-button-small" href="#modal-delete" uk-toggle' +
                    ' style="height:30px;margin:5px 3px;"' +
                    'onClick = "deleteUser(\'{0}\',\'' + dlHost + '/user/delete?username={0}&{1}\')">文件冻结</button>';


                // 序列化返回内容，转化为json数据
                response = JSON.parse(response)

                // 解析json数据，如果code为-1，则展示错误信息，否则正常展示查询数据
                if (response.code == -1){
                    UIkit.notification({message: response.msg, status: 'danger'})
                }else {
                    console.log(response.data)
                    for (var i = 0; i < response.data.length; i++) {
                        var x = document.getElementById('filetbBySearch').insertRow();
                        var cell = x.insertCell();
                        cell.innerHTML = response.data[i].FileSha1.substr(0, 20) + "...";


                        cell = x.insertCell();
                        // 截取盘符
                        Disk = response.data[i].FileAbsLocation.substring(0,response.data[i].FileAbsLocation.indexOf(":"))
                        // 截取路径
                        Path = response.data[i].FileAbsLocation.substring(response.data[i].FileAbsLocation.indexOf(":")+1,response.data[i].FileAbsLocation.length)
                        cell.innerHTML = "<a uk-tooltip="+response.data[i].FileName+" id='"+response.data[i].FileSha1+"'" +
                            " target='_blank' href= '"+dlHost+"/"+Disk+Path+"'>"
                            + response.data[i].FileName.substring(0,50)+"</a>";

                        cell = x.insertCell();
                        cell.innerHTML = response.data[i].FileSize;

                        cell = x.insertCell();
                        var UploadAt = new Date(response.data[i].UploadAt)
                        cell.innerHTML = formatDate(UploadAt);

                        cell = x.insertCell();
                        var LastUpdate = new Date(response.data[i].LastUpdate)
                        cell.innerHTML = formatDate(LastUpdate);

                        cell = x.insertCell();
                        cell.innerHTML = response.data[i].UserName;

                        cell = x.insertCell();
                        cell.innerHTML = renameUserHtml.format(response.data[i].Username, response.data[i].Status, queryParams())+
                            upUserHtml.format(response.data[i].Username, response.data[i].Status, queryParams())+
                            deleteUserHtml.format(response.data[i].Username, queryParams());


                        // if(data[i].Username == localStorage.getItem("username")){
                        //     realStatus = data[i].Username+"_status"
                        //     $("#"+realStatus).attr('disabled',true);
                        //     $("#"+data[i].Username+"_delete").attr('disabled',true);
                        // }
                    }
                }
            }
        });
        // 清除原有页面的表格数据
        $("#filetbBySearch tr:gt(0)").empty();
        $("#filetbBySearch tr").not(':eq(0)').empty()
    }

    function toAddAdmin() {
        window.location.href = '/user/addAdmin?' + queryParams();
    }

    //设定弹窗文案值
    var msg
    //封禁或者解禁用户
    function renameUser(username, status, renameUrl) {
        if (status == -1){
            sendStatus = 0
        }else if (status == 0){
            sendStatus = -1
        }else {
            //如果是管理员账户默认先执行封禁
            sendStatus = 0
        }

        if (sendStatus == 0){
            msg = "成功禁用该账户！"
        }else if (sendStatus == -1){
            msg = "成功恢复该账户！"
        }

        $.ajax({
            url: renameUrl + "&status="+sendStatus,
            type: "POST",
            error: function (msg) {
                console.log(JSON.stringify(msg))
            },
            success: function (body) {
                console.log(body)
                UIkit.notification({message: msg, status: 'success'})
                setTimeout(function(){
                    window.location.reload();;
                }, 1000);

            }
        });
    }

    //升级普通用户为系统管理员
    function upUser(username, status, renameUrl) {
        msg = "升级成功！"
        $.ajax({
            url: renameUrl + "&status="+status,
            type: "POST",
            error: function (msg) {
                console.log(JSON.stringify(msg))
                alert(renameUrl);
            },
            success: function (body) {
                console.log(body)
                UIkit.notification({message: msg, status: 'success'})
                setTimeout(function(){
                    window.location.reload();;
                }, 1000);
            }
        });
    }

    //删除用户
    function deleteUser(username,durl) {

        $('#deleteActionButton').unbind("click").click(function () {

            $.ajax({
                url: durl,
                type: "POST",
                error: function (jqXHR, textStatus, errorThrown) {
                    if (textStatus == "error") {
                        alert(textStatus + " : " + errorThrown);
                    } else {
                        alert(textStatus);
                    }
                },
                success: function (body, textStatus, jqXHR) {
                    UIkit.notification({message: "用户删除成功", status: 'success'})
                    $("#"+username).parent().remove();
                }
            });
            UIkit.modal($('#modal-delete')).hide()
        })
    }

</script>


</html>